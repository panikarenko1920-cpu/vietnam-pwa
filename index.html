// === –§—É–Ω–∫—Ü–∏–∏ ===
function createGallery(folder){
  const gallery=document.createElement('div'); gallery.className='gallery';
  for(let i=1;i<=10;i++){
    const img=document.createElement('img');
    img.src=`${folder}/${i}.jpg`;
    img.onerror=()=>img.remove();
    gallery.appendChild(img);
  }
  return gallery;
}

function addEditForm(section, cityId, dayIndex){
  const formWrapper=document.createElement('div'); formWrapper.className='edit-form';
  formWrapper.innerHTML=`
    <button class="edit-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
    <div class="edit-inner" style="display:none;margin-top:6px;">
      <label>–¢–∏–ø:
        <select class="item-type">
          <option value="attraction">–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å üèõ</option>
          <option value="food">–ï–¥–∞ üçú</option>
        </select>
      </label>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ:<input type="text" class="item-name"></label>
      <label>–û–ø–∏—Å–∞–Ω–∏–µ:<input type="text" class="item-desc"></label>
      <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ URL:<input type="text" class="item-img"></label>
      <button class="add-item-btn">–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
    </div>`;
  section.appendChild(formWrapper);

  const editBtn=formWrapper.querySelector('.edit-btn');
  const editInner=formWrapper.querySelector('.edit-inner');
  editBtn.onclick=()=>{editInner.style.display=(editInner.style.display==='none')?'block':'none';}

  const addBtn=formWrapper.querySelector('.add-item-btn');
  addBtn.onclick=()=>{
    const type=formWrapper.querySelector('.item-type').value;
    const name=formWrapper.querySelector('.item-name').value.trim();
    const desc=formWrapper.querySelector('.item-desc').value.trim();
    const img=formWrapper.querySelector('.item-img').value.trim();
    if(!name)return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
    
    const card=document.getElementById(cityId);
    const sectionEl=section;
    const h4Selector=type==='attraction'?'–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üèõ':'–ï–¥–∞ üçú';
    
    let ul=Array.from(sectionEl.querySelectorAll('ul'))
      .find(u=>u.previousSibling && u.previousSibling.textContent===h4Selector);
    if(!ul){
      const h4=document.createElement('h4'); h4.textContent=h4Selector; h4.style.marginTop='6px';
      sectionEl.appendChild(h4);
      ul=document.createElement('ul');
      sectionEl.appendChild(ul);
    }
    
    const li=document.createElement('li');
    li.innerHTML=`<strong>${name}</strong>${desc?': '+desc:''}${img?`<br><img src="${img}" style="width:100px;height:70px;object-fit:cover;border-radius:8px;margin-top:4px;">`:''}`;
    ul.appendChild(li);

    // localStorage
    const storageKey=`trip_${cityId}_day${dayIndex}`;
    const existing=JSON.parse(localStorage.getItem(storageKey)||'{}');
    if(!existing[type])existing[type]=[];
    existing[type].push({name,desc,img});
    localStorage.setItem(storageKey,JSON.stringify(existing));

    formWrapper.querySelectorAll('input').forEach(i=>i.value='');
  };
}

function loadSavedItems(cityId, dayIndex){
  const storageKey=`trip_${cityId}_day${dayIndex}`;
  const data=JSON.parse(localStorage.getItem(storageKey)||'{}');
  if(!data)return;
  const card=document.getElementById(cityId);
  const section=card.querySelectorAll('.section')[dayIndex];

  ['attraction','food'].forEach(type=>{
    if(!data[type]||!data[type].length)return;
    const h4Selector=type==='attraction'?'–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üèõ':'–ï–¥–∞ üçú';
    let ul=Array.from(section.querySelectorAll('ul'))
      .find(u=>u.previousSibling && u.previousSibling.textContent===h4Selector);
    if(!ul){
      const h4=document.createElement('h4'); h4.textContent=h4Selector; h4.style.marginTop='6px';
      section.appendChild(h4);
      ul=document.createElement('ul'); section.appendChild(ul);
    }
    data[type].forEach(item=>{
      const li=document.createElement('li');
      li.innerHTML=`<strong>${item.name}</strong>${item.desc?': '+item.desc:''}${item.img?`<br><img src="${item.img}" style="width:100px;height:70px;object-fit:cover;border-radius:8px;margin-top:4px;">`:''}`;
      ul.appendChild(li);
    });
  });
}

// === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ ===
const mainContainer=document.getElementById('main-container');
const dayIndices={};
tripData.forEach(city=>{
  dayIndices[city.city.toLowerCase()]=0;
  const card=document.createElement('div'); card.id=city.city.toLowerCase(); card.className='card';
  const h2=document.createElement('h2'); h2.textContent=city.city; card.appendChild(h2);

  city.days.forEach((day,dayIndex)=>{
    const section=document.createElement('div'); section.className='section';
    const h3=document.createElement('h3'); h3.textContent=`–î–µ–Ω—å ${day.day} ${day.title}`; section.appendChild(h3);

    if(day.attractions && day.attractions.length){
      const h4a=document.createElement('h4'); h4a.textContent="–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üèõ"; section.appendChild(h4a);
      const ulA=document.createElement('ul'); day.attractions.forEach(a=>{ const li=document.createElement('li'); li.textContent=a; ulA.appendChild(li); }); section.appendChild(ulA);
    }
    if(day.food && day.food.length){
      const h4f=document.createElement('h4'); h4f.textContent="–ï–¥–∞ üçú"; section.appendChild(h4f);
      const ulF=document.createElement('ul'); day.food.forEach(f=>{ const li=document.createElement('li'); li.textContent=f; ulF.appendChild(li); }); section.appendChild(ulF);
    }

    section.appendChild(createGallery(day.folder));
    addEditForm(section, city.city.toLowerCase(), dayIndex);
    loadSavedItems(city.city.toLowerCase(), dayIndex);

    card.appendChild(section);
  });

  const nav=document.createElement('div'); nav.className='day-nav';
  const prevBtn=document.createElement('button'); prevBtn.textContent='‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å';
  const nextBtn=document.createElement('button'); nextBtn.textContent='–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å ‚Üí';
  nav.appendChild(prevBtn); nav.appendChild(nextBtn); card.appendChild(nav);

  mainContainer.appendChild(card);

  const numDays=city.days.length;
  prevBtn.onclick=()=>{ dayIndices[city.city.toLowerCase()]--; if(dayIndices[city.city.toLowerCase()]<0) dayIndices[city.city.toLowerCase()]=numDays-1; showDay(city.city.toLowerCase(), dayIndices[city.city.toLowerCase()]); };
  nextBtn.onclick=()=>{ dayIndices[city.city.toLowerCase()]++; if(dayIndices[city.city.toLowerCase()]>=numDays) dayIndices[city.city.toLowerCase()]=0; showDay(city.city.toLowerCase(), dayIndices[city.city.toLowerCase()]); };
});

function showDay(cityId,dayIndex){
  const card=document.getElementById(cityId);
  const sections=card.querySelectorAll('.section');
  sections.forEach((sec,idx)=>sec.style.display=(idx===dayIndex)?'block':'none');
}
Object.keys(dayIndices).forEach(cityId=>showDay(cityId,0));

// === –ú–µ–Ω—é –≥–æ—Ä–æ–¥–æ–≤ ===
const attrButtons=document.getElementById('attr-buttons');
const foodButtons=document.getElementById('food-buttons');
tripData.forEach(city=>{
  const btnA=document.createElement('button'); btnA.textContent=city.city;
  btnA.onclick=()=>{
    openCity(city.city.toLowerCase());
    sidebar.classList.remove('open'); burger.classList.remove('active');
  }; attrButtons.appendChild(btnA);

  const btnF=document.createElement('button'); btnF.textContent=city.city;
  btnF.onclick=()=>{
    openCity(city.city.toLowerCase());
    sidebar.classList.remove('open'); burger.classList.remove('active');
  }; foodButtons.appendChild(btnF);
});

function openCity(cityId){
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
  document.getElementById(cityId).classList.add('active');
  showDay(cityId,0);
}

// === Service Worker ===
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}
